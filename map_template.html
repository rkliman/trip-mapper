<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Combined Trip Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }
    .legend {
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    .legend h4 { margin: 0 0 10px 0; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    // Initialize map
    var map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var bounds = L.latLngBounds();

    // Layer groups
    var carLayer = L.layerGroup();
    var planeLayer = L.layerGroup();
    var hikeLayer = L.layerGroup();

    // GeoJSON data
    var carGeojsons = {
      {{CAR_FEATURES}}
    };
    var planeGeojsons = {
      {{PLANE_FEATURES}}
    };
    var hikeGeojsons = {
      {{HIKE_FEATURES}}
    };

    // Add car routes
    for (var key in carGeojsons) {
      var layer = L.geoJSON(carGeojsons[key], {
        style: function(f) {
          return {
            color: f.properties.stroke || '#2563eb',
            weight: f.properties["stroke-width"] || 3,
            dashArray: f.properties["stroke-dasharray"] || null,
            opacity: 0.8
          };
        }
      }).addTo(carLayer);

      layer.bindPopup('<strong>' + carGeojsons[key].properties.name + '</strong><br>Method: ' + carGeojsons[key].properties.method + '<br>Distance: ' + carGeojsons[key].properties.distance.toFixed(1) + ' miles');

      layer.eachLayer(function(l) {
        if (l.getBounds) {
          bounds.extend(l.getBounds());
        }
      });
    }

    // Add plane routes
    for (var key in planeGeojsons) {
      var layer = L.geoJSON(planeGeojsons[key], {
        style: function(f) {
          return {
            color: f.properties.stroke || '#dc2626',
            weight: f.properties["stroke-width"] || 2,
            dashArray: f.properties["stroke-dasharray"] || null,
            opacity: 0.8
          };
        }
      }).addTo(planeLayer);

      layer.bindPopup('<strong>' + planeGeojsons[key].properties.name + '</strong><br>Method: ' + planeGeojsons[key].properties.method + '<br>Distance: ' + planeGeojsons[key].properties.distance.toFixed(1) + ' miles (great circle)');

      layer.eachLayer(function(l) {
        if (l.getBounds) {
          bounds.extend(l.getBounds());
        }
      });
    }

    // Add hiking/walking routes
    for (var key in hikeGeojsons) {
      var layer = L.geoJSON(hikeGeojsons[key], {
        style: function(f) {
          return {
            color: f.properties.stroke || '#00ff08',
            weight: f.properties["stroke-width"] || 5,
            dashArray: f.properties["stroke-dasharray"] || "8,4",
            opacity: 0.8
          };
        }
      }).addTo(hikeLayer);

      layer.bindPopup('<strong>' + hikeGeojsons[key].properties.name + '</strong><br>Method: ' + hikeGeojsons[key].properties.method + '<br>Distance: ' + hikeGeojsons[key].properties.distance.toFixed(1) + ' miles');

      layer.eachLayer(function(l) {
        if (l.getBounds) {
          bounds.extend(l.getBounds());
        }
      });
    }

    // Add layers to map
    carLayer.addTo(map);
    planeLayer.addTo(map);
    hikeLayer.addTo(map);

    // Layer control
    var overlays = {
      "Car Trips": carLayer,
      "Plane Trips": planeLayer,
      "Hiking/Walking": hikeLayer
    };
    L.control.layers(null, overlays).addTo(map);

    // Add markers
    {{MARKERS}}

    // Fit bounds
    if (bounds.isValid()) {
      map.fitBounds(bounds, {padding: [20, 20]});
    }

    // Add custom legend
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <h4>Trip Types</h4>
        <div><span style="color: #2563eb; font-weight: bold;">━━━</span> Car Trips</div>
        <div><span style="color: #dc2626; font-weight: bold;">━━━</span> Plane Trips</div>
        <div><span style="color: #FFA500; font-weight: bold;">━━━</span> Hiking/Walking</div>
        <div style="margin-top: 10px;">
          <span style="color: #dc2626;">●</span> Start/End Points<br>
          <span style="color: #2563eb;">●</span> Waypoints
        </div>
      `;
      return div;
    };
    legend.addTo(map);

    // Add all routes with GeoJSON properties for styling
    var allGeojsons = {
      {{CAR_FEATURES}},
      {{PLANE_FEATURES}}
    };

    for (var key in allGeojsons) {
      var feature = allGeojsons[key];
      var layer = L.geoJSON(feature, {
        style: function(f) {
          // Use GeoJSON properties for color and dash
          return {
            color: f.properties.stroke || "#3388ff",
            weight: f.properties["stroke-width"] || 3,
            dashArray: f.properties["stroke-dasharray"] || null,
            opacity: 0.8
          };
        }
      }).addTo(map);

      layer.bindPopup(
        '<strong>' + (feature.properties.name || '') + '</strong><br>' +
        'Method: ' + (feature.properties.method || '') + '<br>' +
        'Distance: ' + (feature.properties.distance ? feature.properties.distance.toFixed(1) : '?') + ' miles'
      );

      layer.eachLayer(function(l) {
        if (l.getBounds) {
          bounds.extend(l.getBounds());
        }
      });
    }
  </script>
</body>
</html>